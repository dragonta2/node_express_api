<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToDoリスト</title>
  <style>
    html {
      background: rgb(240, 240, 240);
    }
  </style>
</head>

<body>
  <h1>ToDoリスト</h1>
  <div>
    <ul id="todo-container"></ul>
    <input type="text" id="new-todo-item-title"><button id="new-todo-item-add-button">Add</button>
  </div>


  <script>

    // チェックボックスの値が変わったときに呼ばれる関数
    function checkboxListener(event) {
      const checkbox = event.currentTarget;
      const id = checkbox.dataset.id;

      const body = new FormData();
      body.append('done', checkbox.checked.toString());

      // PUTメソッドでAPIにアクセス
      // 実行後にリスト更新
      fetch(`./api/v1/item/${id}`, { method: 'PUT', body })
        .then(() => fetchTodoList());
    }

    // Deleteボタンを押したときに呼ばれる関数
    function deleteButtonListener(event) {
      const button = event.currentTarget;
      const id = button.dataset.id;

      // DELETEメソッドでAPIにアクセス
      // 削除後にリスト更新
      fetch(`./api/v1/item/${id}`, { method: 'DELETE' })
        .then(() => fetchTodoList());
    }


    // todoリストを描画
    function renderTodoList(todoList) {

      // id="todo-container"要素を取得
      const todoContainer = document.querySelector('#todo-container');

      /* ----- コンテナの中身を一旦、全部消す一連の処理 ----- */

      // #todo-container内にある全ての.delete-button要素を格納
      const deleteButtonList = todoContainer.querySelectorAll('.delete-button');

      // 全ての.delete-buttonをループして削除のクリックイベントを外す
      deleteButtonList.forEach((button) => button.removeEventListener('click', deleteButtonListener));

      // #todo-container内にある全ての.checkbox要素を格納
      const checkboxList = todoContainer.querySelectorAll('.checkbox');

      // 全ての.checkboxをループしてチェックボックスのチェンジイベントを外す
      checkboxList.forEach((checkbox) => checkbox.removeEventListener('change', checkboxListener));

      // コンテナの中身の要素を全部空にする
      todoContainer.innerHTML = '';

      /* ----- /コンテナの中身を一旦、全部消す一連の処理 ----- */

      // json各要素に対して
      for (const item of todoList) {
        const li = document.createElement('li'); // リスト要素
        const label = document.createElement('label'); // ラベル
        const checkbox = document.createElement('input'); // チェックボックス
        checkbox.type = 'checkbox';
        checkbox.classList.add('checkbox');
        checkbox.checked = item.done; // 項目がdoneならチェック状態にする
        checkbox.dataset.id = item.id; // data-id属性に アイテムのidの値を入れる。
        checkbox.addEventListener('change', checkboxListener); // チェンジイベントを与える
        const text = new Text(item.title); // 項目名

        const deleteButton = document.createElement('button'); // 削除ボタン
        deleteButton.innerText = 'Delete';
        deleteButton.classList.add('delete-button');
        deleteButton.dataset.id = item.id;
        deleteButton.addEventListener('click', deleteButtonListener);

        // ラベルにチェックボックスとテキストを追加
        label.appendChild(checkbox);
        label.appendChild(text);
        label.appendChild(deleteButton);

        // リスト要素に先程のラベルを追加する
        li.appendChild(label);

        // ToDoリストにリスト要素を追加する
        todoContainer.appendChild(li);

      }
    };

    // APIからTODOリストを取得して描画する関数
    async function fetchTodoList() {

      // APIからJSONを取得する
      return fetch('./api/v1/list')
        .then((response) => response.json())
        .then((todoList) => {

          // htmlにtodoList配列を描画
          renderTodoList(todoList);
        });
    };

    // APIに新しいTODOアイテムをPOSTする関数
    async function postNewTodoItem(todoItem) {

      // 送信データ'title'にタイトルテキストを追加する
      const body = new FormData();
      body.append('title', todoItem.title);

      // Fetch APIを使って、Web APIにPOSTでデータを送信する
      return fetch('./api/v1/add', {
        method: 'POST', // POSTメソッドで送信する,
        body
      }).then((response) => response.json());
    }

    const newTodoItemTitleInput = document.querySelector('#new-todo-item-title'); // タイトルテキスト
    const newTodoAddButton = document.querySelector('#new-todo-item-add-button'); // Addボタン

    // Addボタンをクリックしたときに新しいTODO項目をPOSTする
    newTodoAddButton.addEventListener('click', (event) => {
      const title = newTodoItemTitleInput.value;

      // タイトルが空でなければ
      if (title) {

        // 項目をPOSTしたあとにリストを更新する
        postNewTodoItem({ title }).then((item) => fetchTodoList());
      }
    });

    // 初回データ読み込み
    fetchTodoList();
  </script>
</body>

</html>
